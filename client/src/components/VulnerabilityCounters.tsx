import { useEffect, useState, useRef } from "react";

export interface VulnerabilityStats {
  critical: number;
  high: number;
  medium: number;
  low: number;
}

interface VulnerabilityCountersProps {
  stats: VulnerabilityStats;
}

export function VulnerabilityCounters({ stats }: VulnerabilityCountersProps) {
  const [pulsingKey, setPulsingKey] = useState<string | null>(null);
  const prevStatsRef = useRef<VulnerabilityStats>({ critical: 0, high: 0, medium: 0, low: 0 });

  useEffect(() => {
    // Determine which counter changed and trigger targeted pulse
    const prev = prevStatsRef.current;
    if (stats.critical > prev.critical) setPulsingKey("critical");
    else if (stats.high > prev.high) setPulsingKey("high");
    else if (stats.medium > prev.medium) setPulsingKey("medium");
    else if (stats.low > prev.low) setPulsingKey("low");
    
    prevStatsRef.current = stats;
    
    // Clear pulsing key after animation
    const timer = setTimeout(() => setPulsingKey(null), 600);
    return () => clearTimeout(timer);
  }, [stats.critical, stats.high, stats.medium, stats.low]);

  const CounterCard = ({ 
    label, 
    value, 
    color, 
    bgColor,
    icon,
    severity
  }: { 
    label: string; 
    value: number; 
    color: string; 
    bgColor: string;
    icon: string;
    severity: "critical" | "high" | "medium" | "low";
  }) => {
    const isPulsing = pulsingKey === severity;
    
    return (
      <div
        key={`${label}`}
        style={{
          flex: 1,
          padding: "0.75rem",
          backgroundColor: bgColor,
          border: `2px solid ${color}`,
          borderRadius: "0.375rem",
          textAlign: "center",
          animation: isPulsing ? "vulnerabilityPulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)" : "none",
          boxShadow: isPulsing ? `0 0 15px ${color}, inset 0 0 10px ${color}25` : `0 0 8px ${color}40`,
          transition: "box-shadow 0.3s ease",
        }}
      >
        <div style={{ fontSize: "1.5rem", marginBottom: "0.25rem" }}>{icon}</div>
        <div style={{ color, fontSize: "0.75rem", fontWeight: "bold", textTransform: "uppercase", letterSpacing: "0.05em" }}>
          {label}
        </div>
        <div style={{ color, fontSize: "2rem", fontWeight: "bold", marginTop: "0.25rem", textShadow: `0 0 10px ${color}` }}>
          {value}
        </div>
      </div>
    );
  };

  return (
    <>
      <style>{`
        @keyframes vulnerabilityPulse {
          0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 currentColor;
          }
          50% {
            transform: scale(1.08);
            box-shadow: 0 0 20px currentColor;
          }
          100% {
            transform: scale(1);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
          }
        }
      `}</style>
      
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(4, 1fr)",
          gap: "0.75rem",
          marginBottom: "1rem",
          fontFamily: "'Fira Code', monospace",
        }}
      >
        <CounterCard
          label="Critical"
          value={stats.critical}
          icon="â˜¢ï¸"
          color="#FF0033"
          bgColor="rgba(255, 0, 51, 0.15)"
          severity="critical"
        />
        <CounterCard
          label="High"
          value={stats.high}
          icon="ðŸ”¥"
          color="#FF6B35"
          bgColor="rgba(255, 107, 53, 0.15)"
          severity="high"
        />
        <CounterCard
          label="Medium"
          value={stats.medium}
          icon="ðŸŸ¡"
          color="#FFAA00"
          bgColor="rgba(255, 170, 0, 0.15)"
          severity="medium"
        />
        <CounterCard
          label="Low"
          value={stats.low}
          icon="ðŸ›¡ï¸"
          color="#00FF00"
          bgColor="rgba(0, 255, 0, 0.15)"
          severity="low"
        />
      </div>
    </>
  );
}
